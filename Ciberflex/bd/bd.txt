/*  BASE DE DATOS PARA PROYECTO LPI  */

CREATE DATABASE CIBERFLEX;

USE CIBERFLEX;

CREATE TABLE PLANES (
	ID_PLAN INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    NOMBRE_PLAN VARCHAR(50) NOT NULL,
    PRECIO_PLAN DECIMAL(15, 2) NOT NULL,
    DESCRIPCION_PLAN VARCHAR(260) NOT NULL,
    ESTADO INT DEFAULT 1
);

CREATE TABLE USUARIOS (
	ID_USUARIO INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
	EMAIL_USUARIO VARCHAR(50) NOT NULL UNIQUE,
	PASSWORD_USUARIO VARCHAR(20) NOT NULL,
    NOMBRE_USUARIO VARCHAR(50) NOT NULL,
    APELLIDO_USUARIO VARCHAR(50) NOT NULL,
    FECHANACIMIENTO_USUARIO DATE,
    DIRECCION_USUARIO VARCHAR (120),
    CIUDAD_USUARIO VARCHAR (30),
    PROVINCIA_USUARIO VARCHAR(30),
    TELEFONO_USUARIO CHAR(12),
    TIPO_USUARIO VARCHAR(20) DEFAULT 'Cliente',
    ID_PLAN INT DEFAULT 1,
    ESTADO INT DEFAULT 1,
    FOREIGN KEY (ID_PLAN) REFERENCES PLANES(ID_PLAN)
);

CREATE TABLE CONTENIDOS(
	ID_CONTENIDO INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    TITULO_CONTENIDO VARCHAR(80) NOT NULL,
    DESCRIPCION_CONTENIDO VARCHAR(260) NOT NULL,
    TIPO_CONTENIDO VARCHAR(20) NOT NULL,
    URLIMAGE_CONTENIDO VARCHAR(260) NOT NULL,
    ESTADO INT DEFAULT 1
);

CREATE TABLE CATEGORIAS(
	ID_CATEGORIA INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    TITULO_CATEGORIA VARCHAR(50) NOT NULL,
    DESCRIPCION_CATEGORIA VARCHAR(260) NOT NULL,
    ESTADO INT DEFAULT 1
);

CREATE TABLE CONTENIDOCATEGORIA(
	ID_CONTENIDO INT NOT NULL,
	ID_CATEGORIA INT NOT NULL,
    PRIMARY KEY (ID_CONTENIDO, ID_CATEGORIA),
    FOREIGN KEY (ID_CONTENIDO) REFERENCES CONTENIDOS(ID_CONTENIDO),
    FOREIGN KEY (ID_CATEGORIA) REFERENCES CATEGORIAS(ID_CATEGORIA)
);

CREATE TABLE VIDEOS(
	ID_VIDEO INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    ID_CONTENIDO INT NOT NULL,
    TITULO_VIDEO VARCHAR(80) NOT NULL,
    TEMPORADA_VIDEO INT,
    DESCRIPCION_VIDEO VARCHAR(260) NOT NULL,
    URL_VIDEO VARCHAR(300) NOT NULL,
    URL_IMAGEN_VIDEO VARCHAR(300) NOT NULL,
    ESTADO INT DEFAULT 1,
    FOREIGN KEY (ID_CONTENIDO) REFERENCES CONTENIDOS(ID_CONTENIDO)
);

CREATE TABLE USUARIOSVIDEOS(
	ID_USUARIO INT NOT NULL,
    ID_VIDEO INT NOT NULL,
    VECESVISTO INT NOT NULL,
    PRIMARY KEY (ID_USUARIO, ID_VIDEO),
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO),
    FOREIGN KEY (ID_VIDEO) REFERENCES VIDEOS(ID_VIDEO)
);


CREATE TABLE USUARIOSCONTENIDOS(
	ID_USUARIO INT NOT NULL,
    ID_CONTENIDO INT NOT NULL,
    PUNTUACION INT,
    PRIMARY KEY (ID_USUARIO, ID_CONTENIDO),
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIOS(ID_USUARIO),
    FOREIGN KEY (ID_CONTENIDO) REFERENCES CONTENIDOS(ID_CONTENIDO)
);

DELIMITER $$
CREATE PROCEDURE PRC_CATEGORIASENCONTENIDO (ID INT)
BEGIN
select c.ID_CATEGORIA, c.TITULO_CATEGORIA, c.DESCRIPCION_CATEGORIA from CATEGORIAS as c
inner join CONTENIDOCATEGORIA as cc on c.ID_CATEGORIA = cc.ID_CATEGORIA
where cc.ID_CONTENIDO = ID;
END $$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE PRC_COMPRARPLANES()
BEGIN
select p.NOMBRE_PLAN, count(p.id_plan) as Usuarios from PLANES as p
inner join usuarios as u
on u.id_plan = p.id_plan;
END $$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE PRC_COMPRARPLANES_PLAN(ID INT)
BEGIN
select p.NOMBRE_PLAN, count(p.id_plan) as Usuarios from PLANES as p
inner join usuarios as u
on u.id_plan = p.id_plan
WHERE U.id_plan = id;
END $$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE PRC_VIDEOMASVISTO()
BEGIN
select c.TITULO_CONTENIDO, v.TITULO_VIDEO, sum(uv.VECESVISTO) as visto from USUARIOSVIDEOS as uv
inner join videos as v
on uv.id_video = v.id_video
inner join CONTENIDOS as c
on c.id_contenido = v.id_contenido
group by c.TITULO_CONTENIDO, v.TITULO_VIDEO
order by visto desc;
END $$
DELIMITER ;

DELIMITER $$
CREATE PROCEDURE PRC_CATEGOMASVISTO()
BEGIN
select cat.TITULO_CATEGORIA, sum(uv.VECESVISTO) as visto from CATEGORIAS as cat
inner join CONTENIDOCATEGORIA as cc
on cat.ID_CATEGORIA = cc.ID_CATEGORIA
inner join VIDEOS as v
on cc.ID_CONTENIDO = v.ID_CONTENIDO
inner join USUARIOSVIDEOS as uv
on uv.ID_VIDEO = v.ID_VIDEO
group by cat.TITULO_CATEGORIA
order by visto desc;
END $$
DELIMITER ;